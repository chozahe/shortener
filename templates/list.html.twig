<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Управление ссылками</title>
    <link rel="stylesheet" href="{{ asset('styles/style.css') }}">
</head>
<body>
{% if all_urls is defined and all_urls|length > 0 %}
    <h1>Список ссылок</h1>
    <table class="links-table">
        <thead>
        <tr>
            <th>Оригинальная ссылка</th>
            <th>Короткая ссылка</th>
            <th>Переходов</th>
            <th>Последний переход</th>
            <th>Создана</th>
            <th>Одноразовая</th>
            <th>Статус</th>
            <th>Действия</th>
        </tr>
        </thead>
        <tbody>
        {% for url in all_urls %}
            <tr class="{{ url.isActive() ? '' : 'inactive' }}">
                <td><a href="{{ url.getOriginalUrl() }}" target="_blank">{{ url.getOriginalUrl() }}</a></td>
                {% if url.isActive() %}
                    <td><a href="{{ url.getShortUrl() }}" target="_blank">{{ url.getShortUrl() }}</a></td>
                {% else %}
                    <td>Ссылка неактивна</td>
                {% endif %}
                <td>{{ url.getVisits() }}</td>
                <td>{{ url.getLastVisit() ? url.getLastVisit()|date('Y-m-d H:i') : 'Еще посещений нет' }}</td>
                <td>{{ url.getCreatedAt()|date('Y-m-d H:i') }}</td>
                <td>{{ url.isDisposable() ? 'Да' : 'Нет' }}</td>
                <td>{{ url.isActive() ? 'Активна' : 'Неактивна' }}</td>
                <td>
                    <button class="delete-button" data-id="{{ url.getId() }}">Удалить</button>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
{% else %}
    <p>Ссылок пока нет. <a href="/">Создайте новую!</a></p>
{% endif %}

<a href="/" class="create-link">Сократить новую ссылку</a>

<script>
    document.querySelectorAll('.delete-button').forEach(button => {
        button.addEventListener('click', function () {
            const urlId = this.dataset.id;

            if (!confirm('Вы уверены, что хотите удалить ссылку?')) {
                return;
            }

            fetch('/delete/' + urlId, {
                method: 'DELETE',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => {
                    if (response.ok) {
                        alert('Ссылка успешно удалена!');
                        location.reload();
                    } else {
                        return response.text().then(text => {
                            throw new Error(text || 'Ошибка при удалении');
                        });
                    }
                })
                .catch(error => {
                    alert('Ошибка: ' + error.message);
                });
        });
    });
</script>
</body>
</html>
